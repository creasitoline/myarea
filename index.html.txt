<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MySpace Pro Cloud</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCn-hXY4R4xq18i3lToUsoTPOHSqgSkTnc",
            authDomain: "myarea-69ea3.firebaseapp.com",
            projectId: "myarea-69ea3",
            storageBucket: "myarea-69ea3.firebasestorage.app",
            messagingSenderId: "205977706737",
            appId: "1:205977706737:web:ae5aa9a14a7ac939a4c950"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let userData = { myLinks: [], myWork: [] };
        let currentTab = 'tutti';
        let editIndex = null;
        let pressTimer;

        const waIcon = "https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg";
        const callIcon = `<svg viewBox="0 0 24 24" fill="#007AFF"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/></svg>`;
        const trashSVG = `<svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>`;
        const editSVG = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7M18.5 2.5a2.121 2.121 0 113 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>`;

        async function loadData(uid) {
            const docRef = doc(db, "users", uid);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) userData = docSnap.data();
            else { userData = { myLinks: [], myWork: [] }; await setDoc(docRef, userData); }
            render();
        }

        async function syncCloud() {
            if (!currentUser) return;
            const docRef = doc(db, "users", currentUser.uid);
            await setDoc(docRef, userData);
        }

        // --- FUNZIONE LOGIN CON PERSISTENZA FORZATA ---
        window.handleAuth = async () => {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('passInput').value;
            try {
                // Ordina a Firebase di ricordare la sessione in locale
                await setPersistence(auth, browserLocalPersistence);
                // Effettua il login
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (e) { 
                alert("Accesso fallito: controlla email e password."); 
            }
        };

        window.logout = () => signOut(auth);

        onAuthStateChanged(auth, (user) => {
            if (user) { 
                currentUser = user; 
                document.getElementById('welcomeScreen').style.display = 'none'; 
                document.getElementById('mainApp').style.display = 'flex'; 
                loadData(user.uid); 
            } else { 
                currentUser = null; 
                document.getElementById('welcomeScreen').style.display = 'flex'; 
                document.getElementById('mainApp').style.display = 'none'; 
            }
        });

        window.render = () => {
            const grid = document.getElementById('appGrid');
            const workContainer = document.getElementById('workContainer');
            grid.innerHTML = ''; workContainer.innerHTML = '';

            if(currentTab === 'lavoro') {
                grid.style.display = 'none'; workContainer.style.display = 'block';
                userData.myWork.forEach((w, i) => {
                    const div = document.createElement('div');
                    div.className = 'work-card';
                    div.innerHTML = `
                        <div class="work-info" onclick="editWork(${i})">
                            <h4>${w.client}</h4>
                            <p>${w.note}</p>
                            <div class="work-meta">${w.date || '---'} â€¢ ${w.hours}h</div>
                        </div>
                        <div class="trash-btn" onclick="askDelete(${i}, 'work')">${trashSVG}</div>
                    `;
                    workContainer.appendChild(div);
                });
            } else {
                grid.style.display = 'grid'; workContainer.style.display = 'none';
                const filtered = currentTab === 'tutti' ? userData.myLinks : 
                                 currentTab === 'contatti' ? userData.myLinks.filter(l => l.category === 'contatti' || l.category === 'whatsapp') :
                                 userData.myLinks.filter(l => l.category === currentTab);
                
                filtered.forEach((l) => {
                    const idx = userData.myLinks.indexOf(l);
                    const div = document.createElement('div');
                    div.className = 'app-icon';
                    let icon = l.category === 'whatsapp' ? `<img src="${waIcon}">` : l.category === 'contatti' ? callIcon : `<img src="https://www.google.com/s2/favicons?sz=128&domain=${l.url}">`;
                    div.innerHTML = `<div class="context-menu" id="menu-${idx}"><div class="context-item" onclick="event.stopPropagation(); editLink(${idx})">${editSVG} Modifica</div><div class="context-item" style="color:var(--danger)" onclick="event.stopPropagation(); askDelete(${idx}, 'link')">${trashSVG} Elimina</div></div><div class="icon-box">${icon}</div><span class="app-name">${l.title}</span>`;
                    div.onclick = () => { if(document.getElementById(`menu-${idx}`).style.display === 'flex') { hideAllMenus(); return; } if (l.url.startsWith('tel:')) window.location.href = l.url; else window.open(l.url, '_blank'); };
                    div.onmousedown = div.ontouchstart = () => { pressTimer = setTimeout(() => { hideAllMenus(); document.getElementById(`menu-${idx}`).style.display = 'flex'; }, 700); };
                    div.onmouseup = div.ontouchend = () => clearTimeout(pressTimer);
                    grid.appendChild(div);
                });
            }
        };

        window.saveData = async () => {
            const type = document.getElementById('typeSelector').value;
            if(type === 'link') {
                const name = document.getElementById('siteName').value; let url = document.getElementById('siteUrl').value; const cat = document.getElementById('siteCategory').value;
                if(name && url) {
                    if(cat === 'whatsapp' && !url.startsWith('http')) url = 'https://wa.me/' + url.replace(/\D/g,'');
                    if(cat === 'contatti' && !url.startsWith('tel:')) url = 'tel:' + url;
                    const item = { title: name, url: url, category: cat };
                    if(editIndex !== null) userData.myLinks[editIndex] = item; else userData.myLinks.push(item);
                }
            } else {
                const work = { client: document.getElementById('workClient').value, note: document.getElementById('workNote').value, hours: document.getElementById('workHours').value, date: document.getElementById('workDate').value };
                if(work.client) { if(editIndex !== null) userData.myWork[editIndex] = work; else userData.myWork.unshift(work); }
            }
            closeModal(); render(); await syncCloud();
        };

        window.askDelete = (index, type) => {
            event.stopPropagation(); hideAllMenus();
            document.getElementById('deleteOverlay').style.display = 'flex';
            document.getElementById('confirmDelete').onclick = async () => {
                if(type === 'work') userData.myWork.splice(index, 1); else userData.myLinks.splice(index, 1);
                document.getElementById('deleteOverlay').style.display = 'none';
                render(); await syncCloud();
            };
        };

        window.changeTab = (tab, el) => { currentTab = tab; document.querySelectorAll('.tab-item').forEach(i => i.classList.remove('active')); el.classList.add('active'); render(); };
        window.hideAllMenus = () => document.querySelectorAll('.context-menu').forEach(m => m.style.display = 'none');
        
        window.openAddModal = () => { 
            editIndex = null; 
            document.getElementById('modalTitle').innerText = "Nuovo Elemento"; 
            document.getElementById('siteName').value = '';
            document.getElementById('siteUrl').value = '';
            document.getElementById('siteCategory').value = 'preferiti';
            document.getElementById('workClient').value = '';
            document.getElementById('workNote').value = '';
            document.getElementById('workHours').value = '';
            document.getElementById('workDate').value = '';
            document.getElementById('typeSelector').value = 'link';
            toggleFields();
            document.getElementById('addModal').style.display = 'block'; 
        };

        window.closeModal = () => document.getElementById('addModal').style.display = 'none';
        window.toggleFields = () => { const isLink = document.getElementById('typeSelector').value === 'link'; document.getElementById('linkFields').style.display = isLink ? 'block' : 'none'; document.getElementById('workFields').style.display = isLink ? 'none' : 'block'; };
        window.editLink = (index) => { hideAllMenus(); editIndex = index; const l = userData.myLinks[index]; document.getElementById('typeSelector').value = 'link'; toggleFields(); document.getElementById('siteName').value = l.title; document.getElementById('siteUrl').value = l.url; document.getElementById('siteCategory').value = l.category; document.getElementById('addModal').style.display = 'block'; };
        window.editWork = (index) => { editIndex = index; const w = userData.myWork[index]; document.getElementById('typeSelector').value = 'lavoro'; toggleFields(); document.getElementById('workClient').value = w.client; document.getElementById('workNote').value = w.note; document.getElementById('workHours').value = w.hours; document.getElementById('workDate').value = w.date; document.getElementById('addModal').style.display = 'block'; };
    </script>

    <style>
        :root { --primary: #007AFF; --bg: #f2f2f7; --work: #FF9500; --danger: #FF3B30; }
        body, html { margin: 0; padding: 0; font-family: -apple-system, sans-serif; background: var(--bg); height: 100%; overflow: hidden; user-select: none; }
        
        #welcomeScreen { position: fixed; inset: 0; background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .login-card { background: rgba(255, 255, 255, 0.95); padding: 40px 30px; border-radius: 30px; text-align: center; width: 85%; max-width: 320px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        .login-input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 12px; border: 1px solid #ddd; text-align: center; font-size: 16px; box-sizing: border-box; }
        .btn-action { background: var(--primary); color: white; border: none; padding: 15px; border-radius: 12px; font-weight: bold; width: 100%; margin-top: 10px; cursor: pointer; }

        #mainApp { display: none; height: 100%; flex-direction: column; }
        .header { background: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; font-weight: 800; font-size: 20px; }
        .content { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 130px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px; }

        .app-icon { display: flex; flex-direction: column; align-items: center; position: relative; }
        .icon-box { width: 58px; height: 58px; border-radius: 14px; background: white; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.08); border: 1px solid #eee; }
        .icon-box img, .icon-box svg { width: 32px; height: 32px; }
        .app-name { font-size: 10px; margin-top: 5px; font-weight: 500; color: #333; text-align: center; }

        .work-card { background: white; padding: 12px 15px; border-radius: 16px; margin-bottom: 8px; border-left: 5px solid var(--work); display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .work-info { flex: 1; cursor: pointer; }
        .work-card h4 { margin: 0; font-size: 15px; color: #333; }
        .work-card p { margin: 2px 0; font-size: 12px; color: #666; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 200px; }
        .work-meta { font-size: 11px; color: var(--primary); font-weight: bold; }
        .trash-btn { padding: 10px; color: var(--danger); cursor: pointer; margin-left: 10px; }
        .trash-btn svg { width: 18px; height: 18px; fill: currentColor; }

        .tab-bar { position: fixed; bottom: 0; width: 100%; background: white; display: flex; padding: 8px 30px 25px 30px; border-top: 1px solid #ddd; box-sizing: border-box; justify-content: space-around; }
        .tab-item { display: flex; flex-direction: column; align-items: center; color: #8e8e93; font-size: 8px; cursor: pointer; min-width: 45px; }
        .tab-item.active { color: var(--primary); }
        .tab-item svg { width: 20px; height: 20px; fill: currentColor; margin-bottom: 2px; }

        .add-btn { position: fixed; bottom: 95px; right: 20px; width: 55px; height: 55px; background: var(--primary); color: white; border-radius: 50%; border: none; font-size: 30px; box-shadow: 0 5px 15px rgba(0,122,255,0.4); z-index: 99; }
        .modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 25px; border-radius: 25px; width: 85%; max-width: 320px; z-index: 2000; box-shadow: 0 0 100px rgba(0,0,0,0.5); }
        .modal input, .modal select { width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; border: 1px solid #ddd; box-sizing: border-box; }
        
        #deleteOverlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 3000; align-items: center; justify-content: center; }
        .del-card { background: white; padding: 30px; border-radius: 25px; text-align: center; width: 260px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .context-menu { position: absolute; top: -15px; background: white; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); display: none; z-index: 500; flex-direction: column; padding: 5px; min-width: 110px; border: 1px solid #eee; }
        .context-item { display: flex; align-items: center; gap: 10px; padding: 10px; font-size: 13px; border-radius: 8px; }
    </style>
</head>
<body onclick="hideAllMenus()">

    <div id="welcomeScreen">
        <div class="login-card">
            <h1>MySpace</h1>
            <input type="email" id="email" class="login-input" placeholder="Email">
            <input type="password" id="passInput" class="login-input" placeholder="Password">
            <button class="btn-action" onclick="handleAuth()">ACCEDI</button>
            <p style="font-size: 12px; color: #fff; margin-top: 15px;">Area Riservata agli abbonati</p>
        </div>
    </div>

    <div id="mainApp">
        <div class="header">
            <div>MySpace Pro</div>
            <div onclick="logout()" style="color:var(--danger); font-size:14px; cursor:pointer">Esci</div>
        </div>
        <div class="content">
            <div class="grid" id="appGrid"></div>
            <div id="workContainer" style="display:none"></div>
        </div>

        <button class="add-btn" onclick="openAddModal()">+</button>

        <div class="tab-bar">
            <div class="tab-item active" onclick="changeTab('tutti', this)"><svg viewBox="0 0 24 24"><path d="M4 11h5V5H4v6zm0 7h5v-6H4v6zm6 0h5v-6h-5v6zm6 0h5v-6h-5v6zm-6-7h5V5h-5v6zm6-6v6h5V5h-5z"/></svg><span>Tutti</span></div>
            <div class="tab-item" onclick="changeTab('preferiti', this)"><svg viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg><span>Preferiti</span></div>
            <div class="tab-item" onclick="changeTab('web', this)"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg><span>Web</span></div>
            <div class="tab-item" onclick="changeTab('social', this)"><svg viewBox="0 0 24 24"><path d="M21 6h-2v9H6v2c0 .55.45 1 1 1h11l4 4V7c0-.55-.45-1-1-1zm-4 6V3c0-.55-.45-1-1-1H3c-.55 0-1 .45-1 1v14l4-4h10c.55 0 1-.45 1-1z"/></svg><span>Social</span></div>
            <div class="tab-item" onclick="changeTab('lavoro', this)"><svg viewBox="0 0 24 24"><path d="M20 6h-4V4c0-1.11-.89-2-2-2h-4c-1.11 0-2 .89-2 2v2H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-8 0h-4V4h4v2z"/></svg><span>Lavoro</span></div>
            <div class="tab-item" onclick="changeTab('contatti', this)"><svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg><span>Contatti</span></div>
        </div>
    </div>

    <div class="modal" id="addModal">
        <h3 id="modalTitle">Nuovo Elemento</h3>
        <select id="typeSelector" onchange="toggleFields()">
            <option value="link">Link / Social / Contatto</option>
            <option value="lavoro">Lavoro (Ore / Note)</option>
        </select>
        <div id="linkFields">
            <input type="text" id="siteName" placeholder="Nome">
            <input type="text" id="siteUrl" placeholder="URL o Numero">
            <select id="siteCategory">
                <option value="preferiti">Preferiti</option>
                <option value="social">Social</option>
                <option value="web">Web</option>
                <option value="contatti">Chiamata</option>
                <option value="whatsapp">WhatsApp</option>
            </select>
        </div>
        <div id="workFields" style="display:none">
            <input type="text" id="workClient" placeholder="Cliente">
            <input type="text" id="workNote" placeholder="Note">
            <input type="number" id="workHours" placeholder="Ore">
            <input type="date" id="workDate">
        </div>
        <button class="btn-action" onclick="saveData()">SALVA</button>
        <button onclick="closeModal()" style="background:none; border:none; color:gray; width:100%; margin-top:10px;">Annulla</button>
    </div>

    <div id="deleteOverlay">
        <div class="del-card">
            <p style="font-weight:bold; color:#333;">Rimuovere definitivamente?</p>
            <button class="btn-action" style="background:var(--danger)" id="confirmDelete">RIMUOVI</button>
            <button onclick="document.getElementById('deleteOverlay').style.display='none'" style="background:none; border:none; color:gray; width:100%; margin-top:10px;">Annulla</button>
        </div>
    </div>
</body>
</html>