<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LAB: Scanner Multi-API</title>
    
    <script src="https://unpkg.com/html5-qrcode"></script>

    <style>
        :root { --primary: #007AFF; --bg: #f2f2f7; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 20px; text-align: center; }
        
        #reader { width: 100%; max-width: 400px; margin: 0 auto; border-radius: 20px; overflow: hidden; background: black; }
        
        .product-card { 
            background: white; border-radius: 25px; padding: 20px; 
            margin-top: 20px; display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: left; animation: slideUp 0.4s ease-out;
        }

        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .product-img { width: 100%; height: 200px; object-fit: contain; border-radius: 15px; background: #fff; }
        .product-title { font-size: 20px; font-weight: bold; margin: 15px 0 5px 0; color: #333; }
        .product-brand { color: #8e8e93; font-size: 14px; margin-bottom: 15px; text-transform: uppercase; }

        .price-comparison { border-top: 1px solid #eee; padding-top: 15px; margin-top: 15px; }
        .price-row { display: flex; justify-content: space-between; padding: 8px 0; font-size: 15px; border-bottom: 1px solid #f9f9f9; }
        .price-row.best { color: #34C759; font-weight: bold; }
        
        .btn-save { 
            background: var(--primary); color: white; border: none; width: 100%; 
            padding: 15px; border-radius: 12px; font-weight: bold; margin-top: 20px; font-size: 16px;
        }

        #status { margin-top: 10px; font-size: 13px; color: #666; }
        .loading-spinner { border: 3px solid #f3f3f3; border-top: 3px solid var(--primary); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-right: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <h2>ScanMe Lab ðŸ§ª</h2>
    <p>Test della scheda prodotto Multi-API</p>

    <div id="reader"></div>
    <div id="status">Inquadra un codice a barre...</div>

    <div id="productCard" class="product-card">
        <img id="pImg" class="product-img" src="" alt="Prodotto">
        <div id="pTitle" class="product-title">Caricamento...</div>
        <div id="pBrand" class="product-brand">---</div>

        <div class="price-comparison">
            <div style="font-weight: bold; margin-bottom: 10px;">Confronto Prezzi Integrato:</div>
            <div class="price-row">
                <span>ðŸ›’ Amazon.it</span>
                <span id="pAmazon">Cerca...</span>
            </div>
            <div class="price-row">
                <span>ðŸ“¦ eBay</span>
                <span id="pEbay">Cerca...</span>
            </div>
            <div class="price-row best">
                <span>ðŸ’Ž Miglior Prezzo Web</span>
                <span id="pWeb">Cerca...</span>
            </div>
        </div>

        <button class="btn-save" onclick="location.reload()">NUOVA SCANSIONE</button>
    </div>

    <script>
        let html5QrCode = new Html5Qrcode("reader");

        // 1. FUNZIONE PRINCIPALE: CERCA DATI SU PIÃ™ PORTALI
        async function fetchAggregatedData(barcode) {
            document.getElementById('status').innerHTML = '<div class="loading-spinner"></div> Ricerca su piÃ¹ database...';
            
            try {
                // Chiamata 1: Open Food Facts (Gratuita per Nome/Foto)
                const offResponse = await fetch(`https://it.openfoodfacts.org/api/v0/product/${barcode}.json`);
                const offData = await offResponse.json();

                if (offData.status === 1) {
                    const p = offData.product;
                    updateUI(p.product_name, p.brands, p.image_url, barcode);
                    
                    // Chiamata 2: Simulo integrazione prezzi (Amazon/Google)
                    // In un'app reale qui useresti SerpApi o simili.
                    simulatePriceSearch(p.product_name);
                } else {
                    alert("Prodotto non trovato. Prova con un altro codice.");
                    startScanner();
                }
            } catch (err) {
                console.error("Errore API:", err);
            }
        }

        // 2. AGGIORNA INTERFACCIA
        function updateUI(name, brand, img, code) {
            document.getElementById('productCard').style.display = 'block';
            document.getElementById('pTitle').innerText = name || "Prodotto Sconosciuto";
            document.getElementById('pBrand').innerText = brand || "Marca generica";
            document.getElementById('pImg').src = img || "https://via.placeholder.com/200?text=No+Photo";
            document.getElementById('status').innerText = "Codice: " + code;
        }

        // 3. SIMULAZIONE AGGREGATORE PREZZI (Professionalizzazione)
        function simulatePriceSearch(query) {
            // Qui simuliamo che l'app stia andando su Amazon ed eBay
            setTimeout(() => {
                const basePrice = (Math.random() * (15 - 5) + 5).toFixed(2);
                document.getElementById('pAmazon').innerText = "â‚¬ " + (parseFloat(basePrice) + 1.20).toFixed(2);
                document.getElementById('pEbay').innerText = "â‚¬ " + (parseFloat(basePrice) + 0.50).toFixed(2);
                document.getElementById('pWeb').innerText = "â‚¬ " + basePrice;
            }, 1200);
        }

        // 4. GESTIONE SCANNER
        function startScanner() {
            const config = { fps: 15, qrbox: { width: 280, height: 150 } }; // Formato rettangolare per codici a barre
            
            html5QrCode.start({ facingMode: "environment" }, config, (decodedText) => {
                html5QrCode.stop();
                if (navigator.vibrate) navigator.vibrate(100);
                fetchAggregatedData(decodedText);
            });
        }

        window.onload = startScanner;
    </script>
</body>
</html>
