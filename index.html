<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>myArea - Digital Workspace</title>
    
    <script src="https://unpkg.com/html5-qrcode"></script>

    <style>
        :root { --primary: #007AFF; --bg: #f2f2f7; --work: #FF9500; --danger: #FF3B30; --success: #34C759; --spesa: #5856D6; }
        body, html { margin: 0; padding: 0; font-family: -apple-system, sans-serif; background: var(--bg); height: 100%; overflow: hidden; }
        
        #mainApp { display: none; height: 100%; flex-direction: column; }
        .header { background: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; }
        .header img { height: 35px; }

        .content { flex: 1; overflow-y: auto; padding: 15px 15px 140px 15px; }
        .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        
        /* Icone stile Smartphone */
        .app-icon { display: flex; flex-direction: column; align-items: center; position: relative; }
        .icon-box { width: 60px; height: 60px; border-radius: 15px; background: white; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05); overflow: hidden; }
        .icon-box img { width: 100%; height: 100%; object-fit: cover; }
        .app-name { font-size: 11px; margin-top: 6px; color: #333; text-align: center; font-weight: 500; }

        /* Card Spesa */
        .spesa-card { background: white; padding: 12px; border-radius: 18px; margin-bottom: 10px; display: flex; align-items: center; gap: 15px; border-left: 5px solid var(--spesa); }
        .spesa-img { width: 50px; height: 50px; border-radius: 10px; object-fit: cover; }
        .spesa-info { flex: 1; }
        .spesa-info h4 { margin: 0; font-size: 14px; }
        
        /* Modal e Scanner */
        .modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 25px; width: 90%; max-width: 350px; z-index: 3000; box-shadow: 0 10px 40px rgba(0,0,0,0.2); max-height: 80vh; overflow-y: auto; }
        .btn-action { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 12px; font-weight: bold; width: 100%; margin-top: 10px; cursor: pointer; }
        
        .price-links { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 15px; }
        .btn-price { font-size: 10px; padding: 8px; border-radius: 8px; border: 1px solid #ddd; text-align: center; text-decoration: none; color: #333; background: #f9f9f9; }

        /* Bottom Tab Bar */
        .tab-bar { position: fixed; bottom: 0; width: 100%; background: white; display: flex; padding: 10px 0 30px 0; border-top: 1px solid #ddd; justify-content: space-around; z-index: 2000; }
        .tab-item { display: flex; flex-direction: column; align-items: center; color: #8e8e93; font-size: 10px; flex: 1; }
        .tab-item.active { color: var(--primary); }
        .tab-item svg { width: 24px; height: 24px; margin-bottom: 4px; }

        #reader { width: 100%; border-radius: 15px; overflow: hidden; margin-bottom: 10px; }
    </style>
</head>
<body>

<div id="mainApp" style="display: flex;">
    <div class="header">
        <strong style="font-size: 20px; color: var(--primary);">myArea</strong>
        <button onclick="openScanner()" style="background: var(--spesa); color:white; border:none; padding:8px 15px; border-radius:10px; font-weight:bold;">üì∏ SCANNER</button>
    </div>

    <div class="content">
        <div id="appGrid" class="grid"></div>
        <div id="spesaList" style="display:none;"></div>
    </div>

    <div class="tab-bar">
        <div class="tab-item active" onclick="switchTab('tutti')">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
            <span>Tutti</span>
        </div>
        <div class="tab-item" onclick="switchTab('spesa')">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/></svg>
            <span>Mia Spesa</span>
        </div>
    </div>
</div>

<div id="scannerModal" class="modal">
    <div id="reader"></div>
    <div id="productPreview" style="display:none; text-align:center;">
        <img id="prevImg" src="" style="width:100px; height:100px; object-fit:contain;">
        <h3 id="prevTitle" style="margin:10px 0 5px 0;"></h3>
        <p id="prevDesc" style="font-size:12px; color:#666;"></p>
        
        <div class="price-links">
            <a id="linkAmazon" class="btn-price" target="_blank">Amazon</a>
            <a id="linkEbay" class="btn-price" target="_blank">eBay</a>
            <a id="linkGoogle" class="btn-price" target="_blank">Google</a>
            <a id="linkTutto" class="btn-price" target="_blank">TuttoPrezzi</a>
        </div>

        <button class="btn-action" onclick="saveProduct()">SALVA IN SPESA</button>
    </div>
    <button onclick="closeScanner()" style="background:none; border:none; color:gray; width:100%; margin-top:15px;">Chiudi</button>
</div>

<script>
    let mySpesa = JSON.parse(localStorage.getItem('mySpesa')) || [];
    let currentProduct = null;
    let html5QrCode = null;

    function switchTab(tab) {
        document.getElementById('appGrid').style.display = tab === 'tutti' ? 'grid' : 'none';
        document.getElementById('spesaList').style.display = tab === 'spesa' ? 'block' : 'none';
        if(tab === 'spesa') renderSpesa();
    }

    // --- LOGICA SCANNER ---
    function openScanner() {
        document.getElementById('scannerModal').style.display = 'block';
        document.getElementById('productPreview').style.display = 'none';
        document.getElementById('reader').style.display = 'block';

        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, 
            (decodedText) => {
                html5QrCode.stop();
                document.getElementById('reader').style.display = 'none';
                fetchProduct(decodedText);
            }
        );
    }

    function closeScanner() {
        if(html5QrCode) html5QrCode.stop();
        document.getElementById('scannerModal').style.display = 'none';
    }

    async function fetchProduct(barcode) {
        try {
            const res = await fetch(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`);
            const data = await res.json();
            if(data.status === 1) {
                const p = data.product;
                currentProduct = {
                    name: p.product_name || "Prodotto sconosciuto",
                    brand: p.brands || "",
                    img: p.image_url || "https://via.placeholder.com/100",
                    barcode: barcode
                };
                showPreview(currentProduct);
            } else {
                alert("Prodotto non trovato nel database.");
            }
        } catch (e) { alert("Errore connessione API"); }
    }

    function showPreview(p) {
        document.getElementById('productPreview').style.display = 'block';
        document.getElementById('prevImg').src = p.img;
        document.getElementById('prevTitle').innerText = p.name;
        document.getElementById('prevDesc').innerText = p.brand;

        // Link Prezzi
        const query = encodeURIComponent(p.name + " " + p.brand);
        document.getElementById('linkAmazon').href = `https://www.amazon.it/s?k=${query}`;
        document.getElementById('linkEbay').href = `https://www.ebay.it/sch/i.html?_nkw=${query}`;
        document.getElementById('linkGoogle').href = `https://www.google.com/search?q=${query}&tbm=shop`;
        document.getElementById('linkTutto').href = `https://www.tuttoprezzi.it/cerca?q=${query}`;
    }

    function saveProduct() {
        mySpesa.unshift(currentProduct);
        localStorage.setItem('mySpesa', JSON.stringify(mySpesa));
        closeScanner();
        switchTab('spesa');
    }

    function renderSpesa() {
        const container = document.getElementById('spesaList');
        container.innerHTML = '<h3>La Mia Spesa</h3>';
        mySpesa.forEach((p, i) => {
            const div = document.createElement('div');
            div.className = 'spesa-card';
            div.innerHTML = `
                <img src="${p.img}" class="spesa-img">
                <div class="spesa-info">
                    <h4>${p.name}</h4>
                    <small>${p.brand}</small>
                </div>
                <div onclick="deleteProduct(${i})" style="color:var(--danger)">üóëÔ∏è</div>
            `;
            container.appendChild(div);
        });
    }

    function deleteProduct(i) {
        if(confirm("Eliminare prodotto?")) {
            mySpesa.splice(i, 1);
            localStorage.setItem('mySpesa', JSON.stringify(mySpesa));
            renderSpesa();
        }
    }
</script>
</body>
</html>
