<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>myArea - Prodotto & Prezzi</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --primary: #007AFF; --bg: #f2f2f7; --accent: #5856D6; --danger: #FF3B30; --success: #34C759; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); margin: 0; padding: 15px; }
        #reader { width: 100%; max-width: 400px; margin: 0 auto; border-radius: 20px; overflow: hidden; background: #000; box-shadow: 0 8px 20px rgba(0,0,0,0.2); }
        
        .product-card { 
            background: white; border-radius: 25px; padding: 20px; margin-top: 15px; 
            display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.08); text-align: left;
            animation: slideUp 0.4s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .header-prod { display: flex; gap: 15px; margin-bottom: 20px; }
        .product-img { width: 90px; height: 90px; object-fit: contain; border-radius: 12px; background: #fff; border: 1px solid #eee; }
        .title-area { flex: 1; }
        .product-title { font-size: 18px; font-weight: bold; color: #1c1c1e; line-height: 1.2; }
        .product-brand { color: #8e8e93; font-size: 14px; margin-top: 4px; }

        .info-pill { display: inline-block; padding: 4px 10px; border-radius: 8px; font-size: 12px; font-weight: bold; margin-top: 8px; }
        .gluten-free { background: #e3f9e5; color: #1db954; }
        .contains-gluten { background: #ffebee; color: #d32f2f; }

        .section-title { font-size: 14px; font-weight: bold; color: #3a3a3c; margin: 15px 0 8px 0; border-bottom: 1px solid #eee; padding-bottom: 4px; }
        .ingredients { font-size: 12px; color: #636366; line-height: 1.4; max-height: 60px; overflow-y: auto; }

        .grid-comparatore { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .btn-shop { 
            padding: 12px; border: none; border-radius: 12px; color: white; font-weight: bold; 
            font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: opacity 0.2s;
        }
        .amazon { background: #FF9900; }
        .google { background: #4285F4; }
        .ebay { background: #0064D2; }
        .trovaprezzi { background: #E6000e; }
        .btn-shop:active { opacity: 0.7; }

        #status { margin: 10px 0; font-size: 13px; color: #8e8e93; text-align: center; }
    </style>
</head>
<body>

    <h3 style="text-align:center">Analisi Prodotto üîç</h3>
    <div id="reader"></div>
    <div id="status">Inquadra un codice a barre...</div>

    <div id="productCard" class="product-card">
        <div class="header-prod">
            <img id="pImg" class="product-img" src="" alt="">
            <div class="title-area">
                <div id="pTitle" class="product-title"></div>
                <div id="pBrand" class="product-brand"></div>
                <div id="pGluten" class="info-pill"></div>
            </div>
        </div>

        <div class="section-title">DETTAGLI / INGREDIENTI</div>
        <div id="pIngredients" class="ingredients"></div>

        <div class="section-title">CONFRONTA PREZZI REALI</div>
        <div class="grid-comparatore">
            <button class="btn-shop amazon" id="goAmazon">Amazon</button>
            <button class="btn-shop google" id="goGoogle">Google Shopping</button>
            <button class="btn-shop ebay" id="goEbay">eBay</button>
            <button class="btn-shop trovaprezzi" id="goTP">Trovaprezzi</button>
        </div>

        <button onclick="location.reload()" style="width:100%; margin-top:20px; padding:15px; border-radius:15px; border:none; background:#f2f2f7; color:#3a3a3c; font-weight:bold;">FAI UN'ALTRA SCANSIONE</button>
    </div>

    <script>
        let html5QrCode = new Html5Qrcode("reader");

        async function analyzeProduct(barcode) {
            document.getElementById('status').innerText = "Analisi in corso...";
            try {
                const response = await fetch(`https://it.openfoodfacts.org/api/v0/product/${barcode}.json`);
                const data = await response.json();

                if (data.status === 1) {
                    const p = data.product;
                    renderCard(p, barcode);
                } else {
                    alert("Prodotto non trovato nel database alimentare. Uso dati generici.");
                    renderCard({ product_name: "Prodotto Generico", brands: "Barcode: "+barcode }, barcode);
                }
            } catch (err) {
                console.error(err);
                document.getElementById('status').innerText = "Errore di connessione.";
            }
        }

        function renderCard(p, code) {
            document.getElementById('productCard').style.display = 'block';
            document.getElementById('pTitle').innerText = p.product_name || "Nome non disponibile";
            document.getElementById('pBrand').innerText = p.brands || "Marca non disponibile";
            document.getElementById('pImg').src = p.image_url || "https://via.placeholder.com/100?text=üì¶";
            document.getElementById('pIngredients').innerText = p.ingredients_text_it || p.ingredients_text || "Ingredienti non disponibili per questo prodotto.";

            // Controllo Glutine (Semplificato)
            const glutenPill = document.getElementById('pGluten');
            const hasGluten = p.allergens_from_ingredients && p.allergens_from_ingredients.toLowerCase().includes('gluten');
            
            if(hasGluten) {
                glutenPill.innerText = "CONTIENE GLUTINE";
                glutenPill.className = "info-pill contains-gluten";
            } else {
                glutenPill.innerText = "SENZA GLUTINE*";
                glutenPill.className = "info-pill gluten-free";
            }

            // Configurazione Link Comparatore
            const query = encodeURIComponent((p.product_name || "") + " " + (p.brands || ""));
            document.getElementById('goAmazon').onclick = () => window.open(`https://www.amazon.it/s?k=${query}`, '_blank');
            document.getElementById('goGoogle').onclick = () => window.open(`https://www.google.com/search?tbm=shop&q=${query}`, '_blank');
            document.getElementById('goEbay').onclick = () => window.open(`https://www.ebay.it/sch/i.html?_nkw=${query}`, '_blank');
            document.getElementById('goTP').onclick = () => window.open(`https://www.trovaprezzi.it/search?libera=${query}`, '_blank');

            document.getElementById('status').innerText = "Scansione completata.";
        }

        function start() {
            const config = { fps: 20, qrbox: { width: 280, height: 160 } };
            html5QrCode.start({ facingMode: "environment" }, config, (text) => {
                html5QrCode.stop();
                if (navigator.vibrate) navigator.vibrate(100);
                analyzeProduct(text);
            });
        }

        window.onload = start;
    </script>
</body>
</html>
