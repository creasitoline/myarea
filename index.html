<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>myArea - Digital Workspace</title>
    
    <script src="https://unpkg.com/html5-qrcode"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCn-hXY4R4xq18i3lToUsoTPOHSqgSkTnc",
            authDomain: "myarea-69ea3.firebaseapp.com",
            projectId: "myarea-69ea3",
            storageBucket: "myarea-69ea3.firebasestorage.app",
            messagingSenderId: "205977706737",
            appId: "1:205977706737:web:ae5aa9a14a7ac939a4c950"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let userData = { myLinks: [], myWork: [], myShopping: [] };
        let currentTab = 'tutti';
        let html5QrCode = null;

        // Icone Standard
        const waIcon = "https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg";
        const callIcon = `<svg viewBox="0 0 24 24" fill="#007AFF"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/></svg>`;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('loginScreen').style.display = 'none';
                const docRef = doc(db, "users", user.uid);
                const snap = await getDoc(docRef);
                if (snap.exists()) userData = snap.data();
                render();
            } else {
                document.getElementById('loginScreen').style.display = 'flex';
            }
        });

        window.changeTab = (tab) => {
            currentTab = tab;
            // Stop scanner se attivo cambiando tab
            if(html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().then(() => {
                    document.getElementById('scannerWrapper').style.display = 'none';
                });
            }
            toggleSheet(false);
            render();
        };

        window.render = () => {
            const grid = document.getElementById('mainGrid');
            const workArea = document.getElementById('workArea');
            const shopArea = document.getElementById('shopArea');
            
            grid.style.display = (currentTab === 'tutti' || currentTab === 'web' || currentTab === 'social' || currentTab === 'contatti') ? 'grid' : 'none';
            workArea.style.display = (currentTab === 'lavoro') ? 'block' : 'none';
            shopArea.style.display = (currentTab === 'shopping') ? 'block' : 'none';

            grid.innerHTML = '';
            let links = userData.myLinks || [];
            if(currentTab !== 'tutti') links = links.filter(l => l.category === currentTab);

            links.forEach((l, i) => {
                const div = document.createElement('div');
                div.className = 'app-icon';
                let icon = l.category === 'whatsapp' ? `<img src="${waIcon}">` : l.category === 'contatti' ? callIcon : `<img src="https://www.google.com/s2/favicons?sz=128&domain=${l.url}">`;
                div.innerHTML = `<div class="icon-box">${icon}</div><span class="app-name">${l.title}</span>`;
                div.onclick = () => window.open(l.url, '_blank');
                grid.appendChild(div);
            });

            // Render Shopping
            const shopList = document.getElementById('shopList');
            shopList.innerHTML = (userData.myShopping || []).map((s, i) => `
                <div class="shop-item">
                    <img src="${s.img}">
                    <div style="flex:1"><b>${s.name}</b><br><small>${s.shop}</small></div>
                    <div style="color:var(--success); font-weight:bold">â‚¬${s.price}</div>
                    <div onclick="deleteShop(${i})" style="color:red; margin-left:10px">Ã—</div>
                </div>
            `).join('');
        };

        window.startScan = () => {
            document.getElementById('scannerWrapper').style.display = 'block';
            if(!html5QrCode) html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, async (code) => {
                html5QrCode.stop();
                document.getElementById('scannerStatus').innerText = "Cerco prodotto...";
                const res = await fetch(`https://it.openfoodfacts.org/api/v0/product/${code}.json`);
                const data = await res.json();
                if(data.status === 1) {
                    window.tempProd = { name: data.product.product_name, img: data.product.image_url || '' };
                    document.getElementById('prodResult').style.display = 'block';
                    document.getElementById('resTitle').innerText = window.tempProd.name;
                }
            });
        };

        window.saveScan = async () => {
            const p = document.getElementById('pPrice').value;
            const s = document.getElementById('pShop').value;
            if(!p || !s) return alert("Inserisci dati");
            userData.myShopping.unshift({...window.tempProd, price: p, shop: s, date: new Date().toLocaleDateString()});
            await setDoc(doc(db, "users", currentUser.uid), userData);
            document.getElementById('scannerWrapper').style.display = 'none';
            render();
        };

        window.toggleSheet = (show) => {
            const s = document.getElementById('sheet');
            s.style.transform = show ? 'translateY(0)' : 'translateY(100%)';
        };

        window.handleLogin = () => {
            const e = document.getElementById('email').value;
            const p = document.getElementById('pass').value;
            signInWithEmailAndPassword(auth, e, p);
        };
    </script>

    <style>
        :root { --primary: #007AFF; --bg: #f2f2f7; --success: #34C759; }
        body { margin: 0; font-family: -apple-system, sans-serif; background: var(--bg); overflow: hidden; }
        
        .nav-top { background: white; padding: 15px; display: flex; justify-content: space-between; border-bottom: 1px solid #ddd; }
        .main-content { height: calc(100vh - 140px); overflow-y: auto; padding: 15px; }

        /* GRIGLIA ICONE - RIPRISTINATA */
        .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px 10px; }
        .app-icon { display: flex; flex-direction: column; align-items: center; }
        .icon-box { width: 60px; height: 60px; background: white; border-radius: 14px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.08); overflow: hidden; }
        .icon-box img { width: 100%; height: 100%; object-fit: cover; }
        .icon-box svg { width: 32px; height: 32px; }
        .app-name { font-size: 11px; margin-top: 5px; color: #333; text-align: center; width: 70px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* SHOPPING LIST */
        .shop-item { background: white; padding: 10px; border-radius: 12px; display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .shop-item img { width: 40px; height: 40px; object-fit: contain; }

        /* BARRA NAVIGAZIONE */
        .tab-bar { position: fixed; bottom: 0; width: 100%; background: white; display: flex; padding: 10px 0 25px; border-top: 1px solid #ddd; }
        .tab { flex: 1; text-align: center; font-size: 10px; color: #8e8e93; }
        .tab svg { width: 24px; height: 24px; display: block; margin: 0 auto 2px; }

        /* SCANNER OVERLAY */
        #scannerWrapper { position: absolute; top:0; left:0; width:100%; background:white; z-index: 100; display:none; padding: 20px; box-sizing: border-box; }
        #reader { width: 100%; border-radius: 15px; overflow: hidden; }

        /* MODALI & SHEET */
        .sheet { position: fixed; bottom: 0; width: 100%; background: white; transition: 0.3s; transform: translateY(100%); z-index: 1000; border-radius: 20px 20px 0 0; padding: 20px; box-sizing: border-box; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); }
        .login-screen { position: fixed; inset: 0; background: var(--primary); z-index: 2000; display: flex; align-items: center; justify-content: center; flex-direction: column; color: white; }
        input { width: 100%; padding: 12px; margin: 5px 0; border-radius: 10px; border: 1px solid #ddd; box-sizing: border-box; }
    </style>
</head>
<body>

    <div id="loginScreen" class="login-screen">
        <h2>myArea</h2>
        <div style="width: 80%;">
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="pass" placeholder="Password">
            <button onclick="handleLogin()" style="width:100%; padding:15px; border-radius:10px; border:none; background:white; color:var(--primary); font-weight:bold; margin-top:10px;">ACCEDI</button>
        </div>
    </div>

    <div class="nav-top">
        <b style="color:var(--primary)">myArea</b>
        <span onclick="location.reload()" style="font-size: 12px; color: #8e8e93;">Aggiorna</span>
    </div>

    <div class="main-content">
        <div id="mainGrid" class="grid"></div>

        <div id="workArea" style="display:none">
            <h3>Registro Ore</h3>
            </div>

        <div id="shopArea" style="display:none">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>Shopping Lab</h3>
                <button onclick="startScan()" style="background:var(--success); color:white; border:none; padding:8px 15px; border-radius:8px; font-weight:bold">+ SCAN</button>
            </div>

            <div id="scannerWrapper">
                <div id="reader"></div>
                <p id="scannerStatus" style="text-align:center">Inquadra il codice</p>
                <div id="prodResult" style="display:none; border:1px solid #ddd; padding:15px; border-radius:12px;">
                    <b id="resTitle"></b>
                    <input type="number" id="pPrice" placeholder="Prezzo â‚¬">
                    <input type="text" id="pShop" placeholder="Negozio">
                    <button onclick="saveScan()" style="width:100%; background:var(--primary); color:white; border:none; padding:12px; border-radius:10px; margin-top:10px;">SALVA</button>
                </div>
                <button onclick="changeTab('shopping')" style="width:100%; background:none; border:none; color:red; margin-top:15px;">Annulla</button>
            </div>

            <div id="shopList" style="margin-top:20px"></div>
        </div>
    </div>

    <div id="sheet" class="sheet">
        <div style="width:40px; height:4px; background:#ddd; margin:0 auto 15px; border-radius:10px;"></div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
            <div class="app-icon" onclick="changeTab('lavoro')">
                <div class="icon-box" style="background:#FF9500; color:white;">ðŸ’¼</div>
                <span>Lavoro</span>
            </div>
            <div class="app-icon" onclick="changeTab('shopping')">
                <div class="icon-box" style="background:#34C759; color:white;">ðŸ›’</div>
                <span>Shopping</span>
            </div>
        </div>
        <button onclick="toggleSheet(false)" style="width:100%; margin-top:20px; padding:10px; border:none; background:#f2f2f7; border-radius:10px;">Chiudi</button>
    </div>

    <div class="tab-bar">
        <div class="tab" onclick="changeTab('tutti')">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
            Home
        </div>
        <div class="tab" onclick="changeTab('web')">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
            Web
        </div>
        <div class="tab" onclick="changeTab('social')">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5s-3 1.34-3 3 1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5s-3 1.34-3 3 1.34 3 3 3z"/></svg>
            Social
        </div>
        <div class="tab" onclick="toggleSheet(true)">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
            Altro
        </div>
    </div>

</body>
</html>
