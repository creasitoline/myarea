<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>myArea - Digital Workspace</title>
    
    <link rel="icon" type="image/png" href="icon.png?v=2">
    <link rel="apple-touch-icon" href="icon.png?v=2">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCn-hXY4R4xq18i3lToUsoTPOHSqgSkTnc",
            authDomain: "myarea-69ea3.firebaseapp.com",
            projectId: "myarea-69ea3",
            storageBucket: "myarea-69ea3.firebasestorage.app",
            messagingSenderId: "205977706737",
            appId: "1:205977706737:web:ae5aa9a14a7ac939a4c950"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let userData = { myLinks: [], myWork: [], myShopping: [] };
        let currentTab = 'tutti';
        let editIndex = null;
        let scannerActive = false;

        // Caricamento dati
        async function loadData(uid) {
            const docRef = doc(db, "users", uid);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) userData = docSnap.data();
            if (!userData.myShopping) userData.myShopping = [];
            render();
        }

        async function syncCloud() {
            if (!currentUser) return;
            await setDoc(doc(db, "users", currentUser.uid), userData);
        }

        // --- FUNZIONI SPESA (MODIFICATE) ---
        window.openScanner = () => {
            document.getElementById('scannerContainer').style.display = 'flex';
            scannerActive = true;
            // Qui andrebbe l'inizializzazione della libreria barcode (es. Quagga o Html5Qrcode)
            console.log("Scanner avviato...");
        };

        window.closeScanner = () => {
            document.getElementById('scannerContainer').style.display = 'none';
            scannerActive = false;
            // Stop camera stream logic
        };

        // Simulazione API con dettagli estesi (Marca, Peso, Nome Completo)
        window.handleScanResult = (barcode) => {
            // Esempio di come l'API deve mappare i dati per la tua richiesta
            const mockApiResult = {
                title: "Pasta Barilla",
                description: "Penne Rigate n.73",
                brand: "Barilla",
                size: "500gr",
                date: new Date().toLocaleDateString()
            };
            
            const fullTitle = `${mockApiResult.brand} - ${mockApiResult.title} (${mockApiResult.size})`;
            document.getElementById('scanResTitle').innerText = fullTitle;
            document.getElementById('scanResDesc').innerText = mockApiResult.description;
            document.getElementById('scanResultModal').style.display = 'block';
            closeScanner();
        };

        window.saveShoppingItem = async () => {
            const newItem = {
                title: document.getElementById('scanResTitle').innerText,
                desc: document.getElementById('scanResDesc').innerText,
                price: document.getElementById('scanResPrice').value || "0.00",
                date: new Date().toLocaleDateString()
            };
            
            if(editIndex !== null) {
                userData.myShopping[editIndex] = newItem;
            } else {
                userData.myShopping.unshift(newItem);
            }
            
            document.getElementById('scanResultModal').style.display = 'none';
            editIndex = null;
            render();
            await syncCloud();
        };

        window.editShoppingItem = (index) => {
            const item = userData.myShopping[index];
            editIndex = index;
            document.getElementById('scanResTitle').innerText = item.title;
            document.getElementById('scanResDesc').innerText = item.desc;
            document.getElementById('scanResPrice').value = item.price;
            document.getElementById('scanResultModal').style.display = 'block';
        };

        // --- RENDERING & CORE ---
        window.render = () => {
            const grid = document.getElementById('appGrid');
            const shoppingList = document.getElementById('shoppingList');
            grid.innerHTML = ''; shoppingList.innerHTML = '';

            if(currentTab === 'spesa') {
                grid.style.display = 'none';
                shoppingList.style.display = 'block';
                userData.myShopping.forEach((item, i) => {
                    const div = document.createElement('div');
                    div.className = 'work-card';
                    div.style.borderLeftColor = 'var(--success)';
                    div.innerHTML = `
                        <div class="work-info" onclick="editShoppingItem(${i})">
                            <h4>${item.title}</h4>
                            <p>${item.desc}</p>
                            <div class="work-meta">${item.date} ‚Ä¢ ‚Ç¨ ${item.price}</div>
                        </div>
                        <div class="trash-btn" onclick="deleteShopping(${i})">üóëÔ∏è</div>
                    `;
                    shoppingList.appendChild(div);
                });
            } else {
                // ... (Rendering standard per Link e Lavoro invariato)
                grid.style.display = 'grid';
                shoppingList.style.display = 'none';
            }
        };

        window.changeTab = (tab, el) => {
            currentTab = tab;
            document.querySelectorAll('.tab-item').forEach(i => i.classList.remove('active'));
            if(el) el.classList.add('active');
            render();
        };

        onAuthStateChanged(auth, (user) => {
            if (user) { currentUser = user; document.getElementById('welcomeScreen').style.display = 'none'; loadData(user.uid); }
            else { document.getElementById('welcomeScreen').style.display = 'flex'; }
        });

        window.handleAuth = async () => {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('passInput').value;
            try { await signInWithEmailAndPassword(auth, email, pass); } catch (e) { alert("Errore"); }
        };
    </script>

    <style>
        :root { --primary: #007AFF; --bg: #f2f2f7; --danger: #FF3B30; --success: #34C759; }
        body { margin: 0; font-family: -apple-system, sans-serif; background: var(--bg); height: 100vh; overflow: hidden; }
        
        #mainApp { height: 100%; display: flex; flex-direction: column; }
        .content { flex: 1; overflow-y: auto; padding: 15px 15px 100px; }
        
        /* Scanner UI */
        #scannerContainer { position: fixed; inset: 0; background: black; z-index: 5000; display: none; flex-direction: column; }
        .scanner-view { flex: 1; background: #222; position: relative; }
        .scanner-controls { padding: 30px; background: rgba(0,0,0,0.8); text-align: center; }

        /* Card Editabili Spesa */
        .work-card { background: white; padding: 15px; border-radius: 18px; margin-bottom: 10px; border-left: 5px solid var(--primary); display: flex; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .work-info { flex: 1; cursor: pointer; }
        
        /* Tab Bar */
        .tab-bar { position: fixed; bottom: 0; width: 100%; background: white; display: flex; padding-bottom: 25px; border-top: 1px solid #ddd; z-index: 2000; }
        .tab-item { flex: 1; text-align: center; padding: 10px; color: #8e8e93; font-size: 10px; }
        .tab-item.active { color: var(--primary); }
        .tab-item svg { width: 24px; height: 24px; display: block; margin: 0 auto 4px; }

        .modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 20px; width: 85%; z-index: 4000; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .login-input { width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; border: 1px solid #ddd; box-sizing: border-box; }
        .btn-action { width: 100%; padding: 12px; border-radius: 10px; border: none; background: var(--primary); color: white; font-weight: bold; margin-top: 10px; }
        .btn-cancel { background: #8e8e93; }
    </style>
</head>
<body>

    <div id="welcomeScreen" style="position:fixed; inset:0; background:var(--primary); z-index:9000; display:none; align-items:center; justify-content:center;">
        <div style="background:white; padding:30px; border-radius:25px; width:80%; max-width:300px; text-align:center;">
            <input type="email" id="email" class="login-input" placeholder="Email">
            <input type="password" id="passInput" class="login-input" placeholder="Password">
            <button class="btn-action" onclick="handleAuth()">ACCEDI</button>
        </div>
    </div>

    <div id="mainApp">
        <div class="content">
            <div id="appGrid" class="grid"></div>
            <div id="shoppingList" style="display:none"></div>
        </div>

        <div id="scannerContainer">
            <div class="scanner-view">
                <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:250px; height:150px; border:2px solid var(--success); border-radius:15px;"></div>
            </div>
            <div class="scanner-controls">
                <button class="btn-action btn-cancel" onclick="closeScanner()">ANNULLA / CHIUDI</button>
            </div>
        </div>

        <div id="scanResultModal" class="modal">
            <h3 style="margin-top:0">Dettagli Prodotto</h3>
            <div id="scanResTitle" contenteditable="true" style="font-weight:bold; border-bottom:1px dashed #ccc; padding:5px;"></div>
            <div id="scanResDesc" contenteditable="true" style="font-size:14px; color:#666; margin:10px 0; border-bottom:1px dashed #ccc; padding:5px;"></div>
            <label style="font-size:12px;">Prezzo (‚Ç¨):</label>
            <input type="number" id="scanResPrice" class="login-input" step="0.01" placeholder="0.00">
            <button class="btn-action" onclick="saveShoppingItem()">SALVA NELLA SPESA</button>
            <button class="btn-action btn-cancel" onclick="document.getElementById('scanResultModal').style.display='none'">CHIUDI</button>
        </div>

        <div class="tab-bar">
            <div class="tab-item active" onclick="changeTab('tutti', this)">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
                Tutti
            </div>
            <div class="tab-item" onclick="changeTab('lavoro', this)">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 6h-4V4c0-1.11-.89-2-2-2h-4c-1.11 0-2 .89-2 2v2H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-8 0h-4V4h4v2z"/></svg>
                Lavoro
            </div>
            <div class="tab-item" onclick="changeTab('spesa', this)">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/></svg>
                Spesa
            </div>
            <div class="tab-item" onclick="openScanner()">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 5v4h2V5h4V3H5c-1.1 0-2 .9-2 2zm2 10H3v4c0 1.1.9 2 2 2h4v-2H5v-4zm14 4h-4v2h4c1.1 0 2-.9 2-2v-4h-2v4zm0-16h-4v2h4v4h2V5c0-1.1-.9-2-2-2z"/></svg>
                Scanner
            </div>
        </div>
    </div>
</body>
</html>
