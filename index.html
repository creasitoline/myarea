<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>myArea - Digital Workspace</title>
    
    <link rel="icon" type="image/png" href="icon.png?v=2">
    <link rel="apple-touch-icon" href="icon.png?v=2">
    <link rel="manifest" href="manifest.json?v=2">
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://unpkg.com/html5-qrcode"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCn-hXY4R4xq18i3lToUsoTPOHSqgSkTnc",
            authDomain: "myarea-69ea3.firebaseapp.com",
            projectId: "myarea-69ea3",
            storageBucket: "myarea-69ea3.firebasestorage.app",
            messagingSenderId: "205977706737",
            appId: "1:205977706737:web:ae5aa9a14a7ac939a4c950"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let userData = { myLinks: [], myWork: [] };
        let currentTab = 'tutti';
        let editIndex = null;
        let pressTimer;
        let searchTerm = "";
        
        // Scanner Variables
        let html5QrCode = null;
        let mySavedDocs = JSON.parse(localStorage.getItem('myAreaDocs')) || [];

        // Assets
        const waIcon = "https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg";
        const callIcon = `<svg viewBox="0 0 24 24" fill="#007AFF"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/></svg>`;
        const trashSVG = `<svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>`;
        const editSVG = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7M18.5 2.5a2.121 2.121 0 113 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>`;

        async function loadData(uid) {
            const docRef = doc(db, "users", uid);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) userData = docSnap.data();
            else { userData = { myLinks: [], myWork: [] }; await setDoc(docRef, userData); }
            render();
        }

        async function syncCloud() {
            if (!currentUser) return;
            const docRef = doc(db, "users", currentUser.uid);
            await setDoc(docRef, userData);
        }

        window.handleAuth = async () => {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('passInput').value;
            try {
                await setPersistence(auth, browserLocalPersistence);
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (e) { alert("Accesso fallito."); }
        };

        window.logout = () => signOut(auth);

        onAuthStateChanged(auth, (user) => {
            if (user) { 
                currentUser = user; 
                document.getElementById('welcomeScreen').style.display = 'none'; 
                document.getElementById('mainApp').style.display = 'flex'; 
                loadData(user.uid); 
            } else { 
                currentUser = null; 
                document.getElementById('welcomeScreen').style.display = 'flex'; 
                document.getElementById('mainApp').style.display = 'none'; 
            }
        });

        // Integrazione Funzioni Scanner nel flusso App
        window.initScanner = async () => {
            if(!html5QrCode) html5QrCode = new Html5Qrcode("reader");
            try {
                await html5QrCode.start({ facingMode: "environment" }, { fps: 15, qrbox: 250 }, onScanSuccess);
            } catch (err) {
                console.error("Errore camera", err);
            }
        };

        async function onScanSuccess(decodedText) {
            await html5QrCode.stop();
            document.getElementById('scanStatus').innerText = "Identificazione...";
            try {
                const response = await fetch(`https://it.openfoodfacts.org/api/v0/product/${decodedText}.json`);
                const data = await response.json();
                let p = { 
                    name: "Prodotto Generico", 
                    brand: "Codice: " + decodedText, 
                    img: "https://via.placeholder.com/100?text=ðŸ“¦",
                    barcode: decodedText 
                };
                if (data.status === 1) {
                    p.name = data.product.product_name || p.name;
                    p.brand = data.product.brands || p.brand;
                    p.img = data.product.image_url || p.img;
                }
                showProduct(p);
            } catch (e) { alert("Errore connessione"); window.initScanner(); }
        }

        function showProduct(p) {
            document.getElementById('productCard').style.display = 'block';
            document.getElementById('resTitle').innerText = p.name;
            document.getElementById('resBrand').innerText = p.brand;
            document.getElementById('resImg').src = p.img;
            
            const query = encodeURIComponent(p.name + " " + p.brand);
            document.getElementById('linkAmz').onclick = () => window.open(`https://www.amazon.it/s?k=${query}`, '_blank');
            document.getElementById('linkGgl').onclick = () => window.open(`https://www.google.com/search?tbm=shop&q=${query}`, '_blank');
            
            window.currentScan = p;
        }

        window.saveToDocs = () => {
            const price = document.getElementById('userPrice').value;
            const shop = document.getElementById('userShop').value;
            if(!price || !shop) { alert("Inserisci prezzo e negozio!"); return; }

            const newDoc = { ...window.currentScan, userPrice: price, userShop: shop, date: new Date().toLocaleDateString() };
            mySavedDocs.unshift(newDoc);
            localStorage.setItem('myAreaDocs', JSON.stringify(mySavedDocs));
            
            document.getElementById('productCard').style.display = 'none';
            document.getElementById('userPrice').value = "";
            document.getElementById('userShop').value = "";
            renderShoppingList();
            window.initScanner();
        };

        window.deleteDoc = (index) => {
            mySavedDocs.splice(index, 1);
            localStorage.setItem('myAreaDocs', JSON.stringify(mySavedDocs));
            renderShoppingList();
        };

        function renderShoppingList() {
            const list = document.getElementById('docsList');
            if(mySavedDocs.length === 0) {
                list.innerHTML = '<p style="color: gray; font-size: 13px; text-align:center;">Nessuna spesa salvata.</p>';
                return;
            }
            list.innerHTML = mySavedDocs.map((d, index) => `
                <div class="doc-item">
                    <img src="${d.img}" width="40">
                    <div style="flex:1; margin-left:10px">
                        <b style="font-size:13px">${d.name}</b><br>
                        <small>${d.userShop} â€¢ ${d.date}</small>
                    </div>
                    <div style="color:var(--success); font-weight:bold">â‚¬${parseFloat(d.userPrice).toFixed(2)}</div>
                    <div onclick="deleteDoc(${index})" style="margin-left:10px; color:var(--danger)">Ã—</div>
                </div>
            `).join('');
        }

        window.changeTab = (tab, el) => { 
            currentTab = tab; 
            document.querySelectorAll('.tab-item').forEach(i => i.classList.remove('active')); 
            if(el) el.classList.add('active'); 
            
            // Ferma lo scanner se cambi tab
            if(html5QrCode && tab !== 'shopping') {
                html5QrCode.stop().catch(() => {});
            }

            if(tab === 'shopping') {
                window.initScanner();
                renderShoppingList();
            }

            document.getElementById('bottomSheet').classList.remove('open');
            document.getElementById('sheetOverlay').classList.remove('active');
            render(); 
        };

        window.render = () => {
            const grid = document.getElementById('appGrid');
            const workContainer = document.getElementById('workContainer');
            const shoppingContainer = document.getElementById('shoppingContainer');
            const searchBar = document.getElementById('searchBarContainer');
            
            grid.style.display = 'none'; 
            workContainer.style.display = 'none'; 
            shoppingContainer.style.display = 'none';
            searchBar.style.display = 'none';

            if(currentTab === 'lavoro') {
                workContainer.style.display = 'block';
                // ... (tua logica lavoro esistente)
            } else if(currentTab === 'shopping') {
                shoppingContainer.style.display = 'block';
            } else {
                grid.style.display = 'grid';
                searchBar.style.display = currentTab === 'cerca' ? 'block' : 'none';
                // ... (tua logica link esistente)
            }
        };

        // Funzioni UI
        window.toggleSheet = () => {
            document.getElementById('bottomSheet').classList.toggle('open');
            document.getElementById('sheetOverlay').classList.toggle('active');
        };
        
        window.openAddModal = () => document.getElementById('addModal').style.display = 'block';
        window.closeModal = () => document.getElementById('addModal').style.display = 'none';
        
    </script>

    <style>
        :root { --primary: #007AFF; --bg: #f2f2f7; --work: #FF9500; --danger: #FF3B30; --success: #34C759; }
        body, html { margin: 0; padding: 0; font-family: -apple-system, sans-serif; background: var(--bg); height: 100%; overflow: hidden; }
        
        #mainApp { display: none; height: 100%; flex-direction: column; }
        .header { background: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; z-index: 10; }
        .header img { height: 30px; }

        .content { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 120px; }
        
        /* Stili Scanner Integrati */
        #reader { width: 100%; border-radius: 15px; overflow: hidden; background: #000; }
        .card-scan { background: white; border-radius: 15px; padding: 15px; margin-top: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .btn-shop { padding: 8px; border: none; border-radius: 8px; color: white; font-weight: bold; font-size: 12px; }
        
        .doc-item { background: white; padding: 10px; border-radius: 12px; margin-bottom: 8px; display: flex; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }

        /* Navigation */
        .tab-bar { position: fixed; bottom: 0; width: 100%; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); display: flex; padding: 10px 0 25px; border-top: 1px solid #ddd; z-index: 1000; }
        .tab-item { flex: 1; text-align: center; color: #8e8e93; font-size: 10px; }
        .tab-item.active { color: var(--primary); }
        .tab-item svg { width: 22px; height: 22px; margin-bottom: 2px; }

        /* Altri stili esistenti della tua app... */
        .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        .add-btn { position: fixed; bottom: 90px; right: 20px; width: 55px; height: 55px; background: var(--primary); color: white; border-radius: 50%; border: none; font-size: 30px; z-index: 99; }
        
        #welcomeScreen { position: fixed; inset: 0; background: var(--primary); display: flex; align-items: center; justify-content: center; z-index: 2000; }
        .login-card { background: white; padding: 30px; border-radius: 20px; width: 80%; text-align: center; }
        .login-input { width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; border: 1px solid #ddd; box-sizing: border-box; }
    </style>
</head>
<body>

    <div id="welcomeScreen">
        <div class="login-card">
            <h2>myArea</h2>
            <input type="email" id="email" class="login-input" placeholder="Email">
            <input type="password" id="passInput" class="login-input" placeholder="Password">
            <button onclick="handleAuth()" style="width:100%; padding:12px; background:var(--primary); color:white; border:none; border-radius:10px; font-weight:bold;">ACCEDI</button>
        </div>
    </div>

    <div id="mainApp">
        <div class="header">
            <span style="font-weight: bold; color: var(--primary);">myArea</span>
            <div onclick="logout()" style="color:var(--danger); font-size:12px;">Esci</div>
        </div>

        <div id="searchBarContainer" style="padding:10px; display:none;">
            <input type="text" placeholder="Cerca..." style="width:100%; padding:8px; border-radius:8px; border:1px solid #ddd;">
        </div>

        <div class="content">
            <div id="appGrid" class="grid"></div>

            <div id="workContainer" style="display:none;"></div>

            <div id="shoppingContainer" style="display:none;">
                <h3 style="text-align:center; margin-top:0;">ScanMe Shopping</h3>
                <div id="reader"></div>
                <div id="scanStatus" style="text-align:center; font-size:12px; color:gray; margin:10px;">Inquadra un codice a barre</div>

                <div id="productCard" class="card-scan" style="display:none;">
                    <div style="display:flex; gap:10px; align-items:center;">
                        <img id="resImg" src="" style="width:60px; height:60px; object-fit:contain;">
                        <div>
                            <b id="resTitle" style="font-size:14px;">Nome</b><br>
                            <small id="resBrand">Marca</small>
                        </div>
                    </div>
                    <div class="shop-grid">
                        <button class="btn-shop" id="linkAmz" style="background:#FF9900;">Amazon</button>
                        <button class="btn-shop" id="linkGgl" style="background:#4285F4;">Google</button>
                    </div>
                    <div style="margin-top:15px; border-top:1px solid #eee; padding-top:10px;">
                        <input type="number" id="userPrice" placeholder="Prezzo â‚¬" style="width:45%; padding:8px; border-radius:8px; border:1px solid #ddd;">
                        <input type="text" id="userShop" placeholder="Negozio" style="width:45%; padding:8px; border-radius:8px; border:1px solid #ddd;">
                        <button onclick="saveToDocs()" style="width:100%; margin-top:10px; padding:10px; background:var(--primary); color:white; border:none; border-radius:8px;">SALVA SPESA</button>
                    </div>
                </div>

                <h4 style="margin-top:25px;">Ultime spese</h4>
                <div id="docsList"></div>
            </div>
        </div>

        <button class="add-btn" onclick="openAddModal()">+</button>

        <div class="tab-bar">
            <div class="tab-item active" onclick="changeTab('tutti', this)">
                <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
                <div>Home</div>
            </div>
            <div class="tab-item" onclick="changeTab('shopping', this)">
                <svg viewBox="0 0 24 24"><path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/></svg>
                <div>Spesa</div>
            </div>
            <div class="tab-item" onclick="toggleSheet()">
                <svg viewBox="0 0 24 24"><path d="M6 10c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm12 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm-6 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
                <div>Altro</div>
            </div>
        </div>
    </div>

    <div id="sheetOverlay" class="sheet-overlay" onclick="toggleSheet()"></div>
    <div id="bottomSheet" class="bottom-sheet">
        <div style="width:40px; height:5px; background:#ddd; border-radius:5px; margin:10px auto;"></div>
        <div style="padding:20px; display:grid; grid-template-columns:repeat(3, 1fr); gap:20px;">
            <div class="tab-item" onclick="changeTab('lavoro', this)">
                <div style="background:#eee; padding:15px; border-radius:15px;">ðŸ’¼</div>
                <span>Lavoro</span>
            </div>
        </div>
    </div>

    <div id="addModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:3000;">
        <div style="background:white; margin:20% auto; padding:20px; width:80%; border-radius:20px;">
            <h4>Nuovo Elemento</h4>
            <button onclick="closeModal()">Chiudi</button>
        </div>
    </div>

</body>
</html>
